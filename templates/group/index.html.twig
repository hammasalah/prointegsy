{% extends 'base.html.twig' %}

{% block title %}Groups - Connect Sphere{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/groups.css') }}">
{% endblock %}

{% block body %}
<div class="groups-container">
    <div class="groups-content">
        <div class="groups-header">
            <h1 class="groups-title">Groups</h1>
            <a href="{{ path('app_group_create') }}" class="create-group-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Create Group
            </a>
        </div>

        {% for message in app.flashes('success') %}
            <div class="alert alert-success">{{ message }}</div>
        {% endfor %}

        <!-- PHP-based Search Form -->
        <div class="group-search-container">
            <form method="get" action="{{ path('app_groups') }}" class="group-search-form">
                <input type="text" name="search" class="group-search-input" 
                       placeholder="Search for groups by name..." 
                       value="{{ app.request.query.get('search') }}"
                       autocomplete="off">
                <button type="submit" class="group-search-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                </button>
            </form>
            {% if app.request.query.get('search') %}
                {% set hasSearchResults = false %}
                {% for group in groups %}
                    {% if group.name|lower matches ('%' ~ app.request.query.get('search')|lower ~ '%') %}
                        {% set hasSearchResults = true %}
                    {% endif %}
                {% endfor %}
                
                {% if not hasSearchResults %}
                    <div class="no-results-message">
                        No groups found matching "{{ app.request.query.get('search') }}"
                        <a href="{{ path('app_groups') }}" class="clear-search-btn">
                            Clear Search
                        </a>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- My Groups Section -->
        <div class="groups-section">
            <div class="section-header">
                <h2 class="section-title">My Groups</h2>
                <span class="section-count">
                    {% set myGroupsCount = 0 %}
                    {% for group in groups %}
                        {% if group.getCreatorId().getId() == currentUser.id %}
                            {% if not app.request.query.get('search') or group.name|lower matches ('%' ~ app.request.query.get('search')|lower ~ '%') %}
                                {% set myGroupsCount = myGroupsCount + 1 %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    ({{ myGroupsCount }})
                </span>
            </div>
            <div class="groups-grid">
                {% set hasMyGroups = false %}
                {% for group in groups %}
                    {% if group.getCreatorId().getId() == currentUser.id %}
                        {% if not app.request.query.get('search') or group.name|lower matches ('%' ~ app.request.query.get('search')|lower ~ '%') %}
                            {% set hasMyGroups = true %}
                            <div class="group-card">
                                <div class="group-body">
                                    <h3 class="group-name">{{ group.name }}</h3>
                                    <p class="group-description">{{ group.description }}</p>
                                    <div class="group-meta">
                                        <span class="group-meta-item">Created by you</span>
                                    </div>
                                    <div class="group-actions" style="margin-top: 0.5rem;">
                                        <a href="{{ path('app_group_view', {'id': group.id}) }}" class="group-btn group-btn-primary">View Group</a>
                                        <a href="{{ path('app_group_edit', {'id': group.id}) }}" class="group-btn group-btn-outline">Edit</a>
                                        <a href="{{ path('app_group_delete', {'id': group.id}) }}" class="group-btn group-btn-danger" onclick="return confirm('Are you sure you want to delete this group?')">Delete</a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                {% if not hasMyGroups %}
                    <p class="no-groups">
                        {% if app.request.query.get('search') %}
                            No matching groups found that you created.
                        {% else %}
                            You haven't created any groups yet.
                        {% endif %}
                    </p>
                {% endif %}
            </div>
        </div>

        <!-- Other Groups Section -->
        <div class="groups-section">
            <div class="section-header">
                <h2 class="section-title">Other Groups</h2>
                <span class="section-count">
                    {% set otherGroupsCount = 0 %}
                    {% for group in groups %}
                        {% if group.getCreatorId().getId() != currentUser.id %}
                            {% if not app.request.query.get('search') or group.name|lower matches ('%' ~ app.request.query.get('search')|lower ~ '%') %}
                                {% set otherGroupsCount = otherGroupsCount + 1 %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    ({{ otherGroupsCount }})
                </span>
            </div>
            <div class="groups-grid">
                {% set hasOtherGroups = false %}
                {% for group in groups %}
                    {% if group.getCreatorId().getId() != currentUser.id %}
                        {% if not app.request.query.get('search') or group.name|lower matches ('%' ~ app.request.query.get('search')|lower ~ '%') %}
                            {% set hasOtherGroups = true %}
                            <div class="group-card">
                                <div class="group-body">
                                    <h3 class="group-name">{{ group.name }}</h3>
                                    <p class="group-description">{{ group.description }}</p>
                                    <div class="group-meta">
                                        <span class="group-meta-item">Created by {{ group.getCreatorId().username }}</span>
                                    </div>
                                    <div class="group-actions" style="margin-top: 0.5rem;">
                                        <a href="{{ path('app_group_view', {'id': group.id}) }}" class="group-btn group-btn-primary">View Group</a>
                                        {% if userGroups[group.id] is defined %}
                                            <a href="{{ path('app_group_leave', {'id': group.id}) }}" class="group-btn group-btn-danger">Leave Group</a>
                                        {% else %}
                                            <a href="{{ path('app_group_join', {'id': group.id}) }}" class="group-btn group-btn-outline">Join Group</a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                {% if not hasOtherGroups %}
                    <p class="no-groups">
                        {% if app.request.query.get('search') %}
                            No matching groups found.
                        {% else %}
                            There are no other groups available.
                        {% endif %}
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}